# Copilot Coding Agent Instructions

## Repository Overview

**tmatrix** is a Python/C++ library for computing seismic properties and pore structure of carbonate rocks using T-matrix theory. It exposes two Python functions (`tmatrix_porosity` and `tmatrix_porosity_noscenario`) backed by a C++ extension built with pybind11 and the Eigen linear algebra library.

- **Languages:** C++14 (core computation), Python (bindings, tests, packaging)
- **Build system:** scikit-build-core + CMake + Conan (C++ dependency management)
- **Package manager:** [uv](https://docs.astral.sh/uv/)
- **Python versions:** 3.11–3.14
- **Key C++ dependencies:** Eigen 3.4.0, pybind11 2.13.5 (managed via Conan)
- **Size:** Small repo (~20 C++ source files, 1 test file, 5 tests)

## Build, Install, and Test

### Install and build (always use this sequence)

```bash
uv sync --locked --all-groups
```

This single command creates a virtualenv in `.venv/`, installs all dependencies (including build tools like cmake, ninja, conan, pybind11), compiles the C++ extension via scikit-build-core, and installs the package in editable/development mode. There is no separate `pip install` or `cmake` step needed.

### Run tests

```bash
uv run pytest
```

Pytest is configured in `pyproject.toml` under `[tool.pytest.ini_options]` with `testpaths = ["tests"]` and options `--color=yes -vv`. All 5 tests should pass. Tests run in ~0.2 seconds.

### After modifying C++ source files

Always rebuild before testing:

```bash
uv sync --locked --all-groups
uv run pytest
```

`uv sync` will detect C++ source changes and recompile the extension. You **must** re-run `uv sync` after any C++ change — running `uv run pytest` alone will test the stale binary.

### Clean rebuild

If you encounter stale build artifacts or unexplained failures:

```bash
rm -rf .venv build
uv sync --locked --all-groups
```

### Lockfile

The `uv.lock` file is committed. Always use `--locked` to ensure reproducible builds. If you add or change a Python dependency in `pyproject.toml`, update it with `uv lock`.

## Project Layout

```
pyproject.toml              # Python project config, build system, pytest config
CMakeLists.txt              # Top-level CMake config (C++14, Eigen, pybind11)
conanfile.txt               # Conan dependencies (eigen/3.4.0, pybind11/2.13.5)
conan_provider.cmake        # CMake-Conan integration (auto-downloads deps)
uv.lock                     # Locked Python dependencies
src/tmatrix/
  __init__.py               # Python entry point — exports tmatrix_porosity, tmatrix_porosity_noscenario
  __init__.pyi              # Type stubs for the two public functions
  py.typed                  # PEP 561 marker
  version.py                # Auto-generated by setuptools-scm (do not edit)
  CMakeLists.txt            # Builds the _tmatrix pybind11 module
  src/
    python.cpp              # pybind11 bindings — defines the Python-callable functions
    TMatrixAPI.hpp           # Public C++ API: TMatrix_Porosity class, enums, Result struct
    TMatrix.hpp              # Internal C++ header: typedefs, function declarations, includes Eigen
    TMatrix_porosity.cpp     # TMatrix_Porosity class implementation (scenarios, evaluate)
    calc_*.cpp               # Individual computation routines (C_eff, Kd, t, td, Theta, X, Z)
    Gtensor.cpp              # Green's tensor computation
    iso_av_all.cpp           # Isotropic averaging
    iso_average.cpp          # Single tensor isotropic average
    velocity_vti_angles.cpp  # VTI velocity computation from effective stiffness
    .clang-format            # C++ formatting: Google-based style, 4-space indent, 80-col limit
tests/
  test_t_matrix.py          # All tests — parametrized over 4 scenarios + noscenario
```

### Key architectural patterns

- The Python module `tmatrix` re-exports functions from the compiled `_tmatrix` C extension.
- `python.cpp` is the bridge: it converts NumPy arrays (via pybind11) to C++ types, calls `TMatrix_Porosity::evaluate()`, and writes results back.
- `TMatrix_Porosity` is the core class. It is constructed with either a `scenario` enum (predefined pore shapes) or custom alpha/v vectors.
- All computation uses Eigen 6×6 and 3×3 matrices with complex-double support.

## CI Pipelines

### Pull Request checks (`.github/workflows/on_pull_request.yml`)

Every PR triggers the test workflow, which runs:
- **Matrix:** `{ubuntu-latest, windows-latest, macos-latest}` × `{3.11, 3.12, 3.13, 3.14}`
- **Steps:** `uv sync --locked --all-groups` → `uv run pytest`

All matrix jobs must pass before merge.

### Main branch (`.github/workflows/build_deploy.yml`)

On push to `main`: runs tests → release-please → (if release) build wheels with cibuildwheel → deploy to PyPI.

## Commit and PR Conventions

- Use [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/) (e.g., `feat:`, `fix:`, `ci:`, `docs:`). These drive automated releases via release-please.
- PRs must be up to date with `main` before merge.
- Code owners: `@equinor/rokdoc-plugins`

## C++ Code Style

A `.clang-format` file exists at `src/tmatrix/src/.clang-format`:
- Based on Google style, 4-space indentation, 80-column limit
- Braces on new line after functions, enums, structs, unions
- Pointer alignment: left (`int* p`)
- Use `clang-format` when editing C++ files

## Important Notes

- The C++ standard is **C++14** (`set(CMAKE_CXX_STANDARD 14)` in the root `CMakeLists.txt`). Do not use C++17 or later features.
- `version.py` is auto-generated by setuptools-scm. Never edit it manually.
- `conan_provider.cmake` is a vendored file from JFrog. Do not modify it.
- There are no Python linters (ruff, flake8, mypy) configured in CI. There is no pre-commit hook.
- Type stubs in `__init__.pyi` must be kept in sync with `python.cpp` if function signatures change.

## Trust These Instructions

These instructions have been validated against the repository. Follow them directly instead of searching for build/test commands. Only search for additional context if these instructions are incomplete or produce errors.
